<!--
=========================================================
* Material Dashboard 2 - v3.0.4
=========================================================

* Product Page: https://www.creative-tim.com/product/material-dashboard
* Copyright 2022 Creative Tim (https://www.creative-tim.com)
* Licensed under MIT (https://www.creative-tim.com/license)
* Coded by Creative Tim

=========================================================

* The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.
-->


<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<!-- header -->
<th:block th:replace="layout/header :: headerFragment"></th:block>


<body class="g-sidenav-show  bg-gray-100">

<!-- side bar -->
<th:block th:replace="layout/aside :: asideFragment"></th:block>


<main class="main-content border-radius-lg ">


    <!-- Navbar -->
    <th:block th:replace="layout/navbar :: navbarFragment"></th:block>



    <div class="container-fluid py-4">
        <div class="row mb-4">
            <div class="col-lg-10 col-md-6 mb-md-0 mb-4">
                <div class="card">
                    <div class="card-header pb-0">
                        <div class="row">
                            <div class="col-lg-9 col-7">
                                <h4>결제</h4>
                                <p class="mb-0" style="font-weight: bold;color: #5A2060">결제를 진행할 수강신청 내역을 선택해주세요.</p>

                            </div>
                            <div class="col-lg-3 col-5 my-auto text-end">
                                <form class="form-inline w-100 justify-content-center " action="/academy/pay"
                                      method="get">
                                    <div class="row mb-4">
                                        <div class="col-8 align-self-center">
                                            <div class="input-group input-group-outline">

                                                <input type="text" class="form-control" name="studentName" placeholder="학생 이름">
                                            </div>
                                        </div>
                                        <div class="col-4  align-self-center">
                                            <button type="submit"
                                                    class="btn btn-sm bg-gradient-primary btn-lg mb-0">검색
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="card-body px-0 pb-2">
                        <div class="table-responsive">
                            <table class="table align-items-center mb-0">
                                <thead>
                                <tr>
                                    <th class="text-center text-uppercase  font-weight-bolder">
                                        학생 이름
                                    </th>
                                    <th class="text-center text-uppercase  font-weight-bolder">
                                        학생 전화번호
                                    </th>
                                    <th class="text-center text-uppercase  font-weight-bolder">
                                        강좌 이름
                                    </th>
                                    <th class="text-center text-uppercase  font-weight-bolder">
                                        강사 이름
                                    </th>
                                    <th class="text-center text-uppercase  font-weight-bolder">
                                        가격
                                    </th>
                                    <th class="text-center text-uppercase  font-weight-bolder">
                                        할인 가격
                                    </th>
                                    <th class="text-center text-uppercase  font-weight-bolder">
                                        결제 여부
                                    </th>
                                    <th class="text-center text-uppercase  font-weight-bolder">
                                        수강신청 일시
                                    </th>

                                </tr>
                                </thead>
                                <tbody>
                                <tr th:each="enrollment : ${enrollments}">
                                    <th class="align-middle text-center">
                                                <span class=" text-xs font-weight-bold"
                                                      th:text="${enrollment.studentName}"></span>
                                    </th>
                                    <td class="align-middle text-center">
                                                <span class=" text-xs font-weight-bold"
                                                      th:text="${enrollment.studentPhoneNum}"></span>
                                    </td>
                                    <td class="align-middle text-center">
                                                <span class=" text-xs font-weight-bold"
                                                      th:text="${enrollment.lectureName}"></span>
                                    </td>
                                    <th class="align-middle text-center">
                                                <span class=" text-xs font-weight-bold"
                                                      th:text="${enrollment.teacherName}"></span>
                                    </th>
                                    <td class="align-middle text-center">
                                                <span class=" text-xs font-weight-bold"
                                                      th:text="${enrollment.price}"></span>
                                    </td>
                                    <td class="align-middle text-center">
                                                <span class=" text-xs font-weight-bold"
                                                      th:text="${enrollment.discount}"></span>
                                    </td>
                                    <td class="align-middle text-center">
                                                <span class=" text-xs font-weight-bold"
                                                      th:text="${enrollment.paymentYN}"></span>
                                    </td>
                                    <td class="align-middle text-center">
                                                <span class=" text-xs font-weight-bold"
                                                      th:text="${enrollment.createdAt}"></span>
                                    </td>
                                    <td class="align-middle text-center">

                                        <button  type="button"  th:data-parameter1="${enrollment.studentId}"  th:data-parameter2="${enrollment.price}" th:data-parameter3="${enrollment.lectureName}" th:data-parameter4="${enrollment.lectureId}" th:data-parameter5="${tossKey}"
                                                 th:onclick="|pay.createOrder(this.getAttribute('data-parameter1'),this.getAttribute('data-parameter2'),this.getAttribute('data-parameter3'),this.getAttribute('data-parameter4'),this.getAttribute('data-parameter5'))|"
                                                class="btn btn-sm bg-gradient-danger btn-lg w-100 mb-0">결제
                                        </button>
                                    </td>

                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!--footer-->
        <th:block th:replace="layout/footer :: footerFragment"></th:block>

    </div>


</main>


<!--   Core JS Files   -->
<script src="/assets/js/core/popper.min.js"></script>
<script src="/assets/js/core/bootstrap.min.js"></script>
<script src="/assets/js/plugins/perfect-scrollbar.min.js"></script>
<script src="/assets/js/plugins/smooth-scrollbar.min.js"></script>
<script src="/assets/js/material-dashboard.min.js?v=3.0.4"></script>
<!-- Toss -->
<script src="https://js.tosspayments.com/v1/payment"></script>
<Script>
    let orderId =null;
    let orderName =null;
    let amount = null;

    let pay = {
        init: function () {
            var _this = this;
        },

        createOrder: function (studentId,amount,orderName,lectureId,tossKey) {
            let data = {
                payType: "CARD",
                amount: amount,
                orderName: orderName,
                lectureId : lectureId
            };
            console.log(data);

            let key = tossKey
            axios.post("/api/v1/payments/students/"+studentId,
                JSON.stringify(data), {
                    headers: {
                        'Content-Type': 'application/json',
                    }
                }
            ).then((response) => {
                console.log(response);
                orderId = response.data.result.orderId;
                orderName = response.data.result.orderName;
                amount = response.data.result.amount;
                var method = "카드";

                console.log(orderId);
                console.log(orderName);
                console.log(amount);
                console.log(key);

                const tossPayments = TossPayments(key);

                var paymentData = {
                    amount: amount,
                    orderId: orderId,
                    orderName: orderName,
                    successUrl: "http://localhost:8080/payment/success",
                    failUrl: "http://localhost:8080/payment/fail"
                };

                tossPayments.requestPayment(method, paymentData);

                alert("결제를 진행해주세요!");
            }).catch((error) => {
                console.log(error);
                if (error.response.data.result["errorCode"] == "ACADEMY_NOT_FOUND") {
                    alert("등록된 학원이 아닙니다. 등록 후 진행해주세요");
                }
            });

        }
    };

    pay.init();

</script>

</body>

</html>
